<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chatter ‚Äî Minimal Social Chat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #0b1020;
        --panel: #121735;
        --muted: #93a5fd;
        --text: #e8eeff;
        --accent: #6c7cff;
        --accent-2: #16db65;
        --danger: #ff5c7a;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        height: 100%;
      }

      body {
        margin: 0;
        background: linear-gradient(120deg, #0b1020, #141a3f);
        color: var(--text);
        font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial,
          sans-serif;
      }

      .app {
        display: grid;
        grid-template-columns: 280px 1fr;
        min-height: 100vh;
      }

      .sidebar {
        background: rgba(18, 23, 53, 0.7);
        backdrop-filter: blur(8px);
        border-right: 1px solid rgba(255, 255, 255, 0.08);
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 700;
      }

      .logo .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--accent-2);
        box-shadow: 0 0 18px var(--accent-2);
      }

      .card {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
      }

      .user-card {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
      }

      .user-card img {
        width: 36px;
        height: 36px;
        border-radius: 50%;
      }

      .btn,
      button,
      input,
      textarea {
        font-family: inherit;
      }

      .btn {
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        background: rgba(255, 255, 255, 0.05);
        color: var(--text);
        cursor: pointer;
      }

      .btn.primary {
        background: var(--accent);
        border-color: transparent;
      }

      .btn.ghost {
        background: transparent;
        border-color: rgba(255, 255, 255, 0.1);
      }

      .btn.full {
        width: 100%;
      }

      .muted {
        color: #a8b0d6;
        font-size: 0.9rem;
      }

      .search {
        display: flex;
        gap: 8px;
        padding: 10px;
      }

      .search input {
        flex: 1;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.2);
        color: var(--text);
      }

      .nav {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 10px;
      }

      .nav .item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        border-radius: 10px;
        cursor: pointer;
      }

      .nav .item.active,
      .nav .item:hover {
        background: rgba(255, 255, 255, 0.08);
      }

      .chats {
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding: 8px;
        overflow: auto;
      }

      .chat-row {
        display: grid;
        grid-template-columns: 46px 1fr auto;
        gap: 10px;
        padding: 10px;
        border-radius: 12px;
        cursor: pointer;
      }

      .chat-row:hover {
        background: rgba(255, 255, 255, 0.06);
      }

      .chat-row img {
        width: 46px;
        height: 46px;
        border-radius: 50%;
      }

      .chat-row .name {
        font-weight: 600;
      }

      .chat-row .last {
        color: #b7bde3;
        font-size: 0.92rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .main {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(18, 23, 53, 0.6);
        backdrop-filter: blur(8px);
      }

      .topbar .title {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .content {
        display: grid;
        grid-template-rows: 1fr auto;
        gap: 0;
        height: calc(100vh - 56px);
      }

      .messages {
        padding: 14px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .bubble {
        max-width: 70%;
        padding: 10px 12px;
        border-radius: 14px;
        line-height: 1.35;
      }

      .me {
        align-self: flex-end;
        background: linear-gradient(135deg, var(--accent), #8e99ff);
      }

      .you {
        align-self: flex-start;
        background: rgba(255, 255, 255, 0.08);
      }

      .composer {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 10px;
        padding: 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        background: rgba(0, 0, 0, 0.15);
      }

      .composer textarea {
        resize: none;
        height: 50px;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.2);
        color: var(--text);
      }

      .auth {
        max-width: 420px;
        margin: 8vh auto;
        padding: 20px;
      }

      .auth .group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin: 8px 0;
      }

      .auth input {
        padding: 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(0, 0, 0, 0.2);
        color: var(--text);
      }

      .switch {
        margin-top: 6px;
        font-size: 0.95rem;
      }

      .empty {
        display: grid;
        place-items: center;
        height: 100%;
        color: #aeb7e9;
      }

      .pill {
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.08);
        border: 1px dashed rgba(255, 255, 255, 0.18);
      }

      @media (max-width: 980px) {
        .app {
          grid-template-columns: 1fr;
        }

        .sidebar {
          position: fixed;
          z-index: 10;
          inset: 0 30% 0 0;
          transform: translateX(-100%);
          transition: 0.25s;
        }

        .sidebar.open {
          transform: none;
        }

        .topbar .menu {
          display: inline-block;
        }

        .topbar .menu button {
          font-size: 20px;
        }

        .topbar .title {
          gap: 8px;
        }
      }

      @media (min-width: 981px) {
        .topbar .menu {
          display: none;
        }
      }
    </style>
  </head>

  <body>
    <div id="root" hidden></div>
    <div id="authView" class="auth card" hidden>
      <div class="logo" style="margin-bottom: 12px">
        <span class="dot"></span> <span>Chatter</span>
      </div>
      <h2 id="authTitle">Create account</h2>
      <div class="group">
        <label>Name</label><input id="nameInput" placeholder="Ada Lovelace" />
      </div>
      <div class="group">
        <label>Email</label
        ><input id="emailInput" type="email" placeholder="ada@chatter.app" />
      </div>
      <div class="group">
        <label>Password</label
        ><input id="passwordInput" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      </div>
      <div class="group">
        <button class="btn primary full" id="authSubmit">Sign up</button>
      </div>
      <div class="group">
        <button class="btn full" id="googleBtn">Continue with Google</button>
      </div>
      <div class="switch" id="authSwitch">
        Already have an account? <a href="#" id="toLogin">Sign in</a>
      </div>
      <p class="muted" style="margin-top: 8px">
        Fill your Firebase config in the script to run locally.
      </p>
    </div>

    <div id="appView" class="app" hidden>
      <aside class="sidebar" id="sidebar">
        <div class="logo"><span class="dot"></span><span>Chatter</span></div>
        <div class="card user-card">
          <img
            id="meAvatar"
            src="https://api.dicebear.com/9.x/thumbs/svg?seed=me"
            alt="me"
          />
          <div>
            <div id="meName" style="font-weight: 600">‚Äî</div>
            <div id="meEmail" class="muted">‚Äî</div>
          </div>
        </div>

        <div class="card search">
          <input id="userSearch" placeholder="Search users by name/email" />
          <button class="btn" id="inviteBtn">+</button>
        </div>

        <div class="nav card">
          <div class="item active" id="navChats">üí¨ Chats</div>
          <div class="item" id="navPeople">üë• People</div>
          <div class="item" id="navProfile">üôç Profile</div>
          <div class="item" id="navLogout">üö™ Logout</div>
        </div>

        <div class="card" style="padding: 8px">
          <div class="muted" style="padding: 8px 8px 0">Recent chats</div>
          <div class="chats" id="recentList"></div>
        </div>

        <div class="muted" style="padding: 8px; text-align: center">
          Built with Firebase
        </div>
      </aside>

      <main class="main">
        <div class="topbar">
          <div class="title">
            <div class="menu">
              <button class="btn ghost" id="toggleSidebar">‚ò∞</button>
            </div>
            <div>
              <strong id="chatTitle">Welcome</strong>
              <div id="chatSub" class="muted" style="font-size: 0.9rem">
                Select a conversation or find people to start chatting.
              </div>
            </div>
          </div>
        </div>

        <div class="content">
          <div class="messages" id="messages"></div>
          <div class="composer" id="composer" hidden>
            <textarea
              id="messageInput"
              placeholder="Type a message‚Ä¶"
            ></textarea>
            <button class="btn primary" id="sendBtn">Send</button>
          </div>
          <div class="empty" id="emptyState">
            <div class="pill">No chat selected</div>
          </div>
        </div>
      </main>
    </div>

    <script type="module">
      // === 1) Fill YOUR Firebase config here ===
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyB6Lh4XsOs8RyvyO2U2gQWO9BcItnYndqA",
        authDomain: "practical11-c6afe.firebaseapp.com",
        projectId: "practical11-c6afe",
        storageBucket: "practical11-c6afe.firebasestorage.app",
        messagingSenderId: "45891733889",
        appId: "1:45891733889:web:06da89bb5e8a38d0ae4080",
        measurementId: "G-4STCBLNH0X",
      };

      // === 2) Firebase SDKs (v10 modular) ===
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut,
        updateProfile,
        GoogleAuthProvider,
        signInWithPopup,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        addDoc,
        collection,
        query,
        where,
        getDocs,
        serverTimestamp,
        onSnapshot,
        orderBy,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // DOM refs
      const authView = document.getElementById("authView");
      const appView = document.getElementById("appView");
      const authTitle = document.getElementById("authTitle");
      const nameInput = document.getElementById("nameInput");
      const emailInput = document.getElementById("emailInput");
      const passwordInput = document.getElementById("passwordInput");
      const authSubmit = document.getElementById("authSubmit");
      const toLogin = document.getElementById("toLogin");
      const googleBtn = document.getElementById("googleBtn");

      const meName = document.getElementById("meName");
      const meEmail = document.getElementById("meEmail");
      const meAvatar = document.getElementById("meAvatar");

      const recentList = document.getElementById("recentList");
      const userSearch = document.getElementById("userSearch");
      const inviteBtn = document.getElementById("inviteBtn");
      const navLogout = document.getElementById("navLogout");
      const navChats = document.getElementById("navChats");
      const navPeople = document.getElementById("navPeople");

      const chatTitle = document.getElementById("chatTitle");
      const chatSub = document.getElementById("chatSub");
      const messagesEl = document.getElementById("messages");
      const composer = document.getElementById("composer");
      const emptyState = document.getElementById("emptyState");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");
      const toggleSidebar = document.getElementById("toggleSidebar");
      const sidebar = document.getElementById("sidebar");

      let isSignup = true;
      let activeChatId = null;
      let messagesUnsub = null; // real-time listener cleanup
      let contactsUnsub = null; // people sidebar live list
      let sidebarMode = "chats"; // 'chats' | 'people'

      const provider = new GoogleAuthProvider();

      function setAuthMode(signup) {
        isSignup = signup;
        authTitle.textContent = signup ? "Create account" : "Welcome back";
        authSubmit.textContent = signup ? "Sign up" : "Sign in";
        nameInput.parentElement.style.display = signup ? "flex" : "none";
        document.getElementById("authSwitch").innerHTML = signup
          ? 'Already have an account? <a href="#" id="toLogin">Sign in</a>'
          : "Don't have an account? <a href='#' id='toSignup'>Create one'</a>";
        document.getElementById("toLogin")?.addEventListener("click", (e) => {
          e.preventDefault();
          setAuthMode(false);
        });
        document.getElementById("toSignup")?.addEventListener("click", (e) => {
          e.preventDefault();
          setAuthMode(true);
        });
      }

      setAuthMode(true);

      googleBtn.addEventListener("click", async () => {
        try {
          const cred = await signInWithPopup(auth, provider);
          await ensureUserDoc(cred.user);
        } catch (e) {
          alert(e.message);
        }
      });

      authSubmit.addEventListener("click", async () => {
        const email = emailInput.value.trim();
        const pass = passwordInput.value.trim();
        try {
          if (isSignup) {
            const name = nameInput.value.trim() || email.split("@")[0];
            const cred = await createUserWithEmailAndPassword(
              auth,
              email,
              pass
            );
            await updateProfile(cred.user, {
              displayName: name,
              photoURL: `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(
                name
              )}`,
            });
            await ensureUserDoc(cred.user);
          } else {
            const cred = await signInWithEmailAndPassword(auth, email, pass);
            await ensureUserDoc(cred.user);
          }
        } catch (e) {
          alert(e.message);
        }
      });

      navLogout.addEventListener("click", () => signOut(auth));
      toggleSidebar.addEventListener("click", () =>
        sidebar.classList.toggle("open")
      );

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          authView.hidden = true;
          appView.hidden = false;
          meName.textContent = user.displayName || "Anonymous";
          meEmail.textContent = user.email || "";
          meAvatar.src =
            user.photoURL ||
            `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(
              user.uid
            )}`;
          setSidebarMode("chats");
        } else {
          appView.hidden = true;
          authView.hidden = false;
          setAuthMode(false);
        }
      });

      async function ensureUserDoc(user) {
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          await setDoc(ref, {
            uid: user.uid,
            name: user.displayName || "Anonymous",
            email: user.email,
            photoURL: user.photoURL || "",
            createdAt: serverTimestamp(),
          });
        }
      }

      // Sidebar mode switching (Chats vs People)
      function setSidebarMode(mode) {
        sidebarMode = mode;
        navChats.classList.toggle("active", mode === "chats");
        navPeople.classList.toggle("active", mode === "people");
        userSearch.value = "";
        recentList.innerHTML = "";
        const me = auth.currentUser;
        if (!me) return;
        if (mode === "chats") {
          loadRecentChats(me.uid);
        } else {
          loadPeople();
        }
      }

      navChats.addEventListener("click", () => setSidebarMode("chats"));
      navPeople.addEventListener("click", () => setSidebarMode("people"));

      // People search & listing (contacts only)
      userSearch.addEventListener(
        "input",
        debounce(async (e) => {
          if (sidebarMode !== "people") return;
          const term = e.target.value.trim().toLowerCase();
          filterPeople(term);
        }, 300)
      );

      let cachedContacts = [];
      function loadPeople() {
        const me = auth.currentUser;
        if (!me) return;
        if (contactsUnsub) {
          contactsUnsub();
          contactsUnsub = null;
        }
        const ref = collection(db, "contacts", me.uid, "items");
        const qy = query(ref, orderBy("createdAt", "desc"));
        contactsUnsub = onSnapshot(qy, async (qs) => {
          cachedContacts = qs.docs.map((d) => ({ id: d.id, ...d.data() }));
          renderPeople(cachedContacts);
        });
      }

      function filterPeople(term) {
        if (!term) {
          renderPeople(cachedContacts);
          return;
        }
        const items = cachedContacts.filter((c) => {
          const name = (c.name || "").toLowerCase();
          const email = (c.email || "").toLowerCase();
          return name.includes(term) || email.includes(term);
        });
        renderPeople(items);
      }

      function renderPeople(users) {
        recentList.innerHTML = "";
        if (!users || users.length === 0) {
          const empty = document.createElement("div");
          empty.className = "muted";
          empty.style.padding = "8px";
          empty.textContent = "No contacts yet. Click + to add by email.";
          recentList.appendChild(empty);
          return;
        }
        users.forEach((u) => {
          const row = document.createElement("div");
          row.className = "chat-row";
          row.innerHTML = `<img src="${
            u.photoURL ||
            u.otherPhoto ||
            `https://api.dicebear.com/9.x/thumbs/svg?seed=${encodeURIComponent(
              u.name || u.uid || u.otherUid
            )}`
          }"><div><div class='name'>${escapeHtml(
            u.name || u.otherName || "User"
          )}</div><div class='last'>${escapeHtml(
            u.email || ""
          )}</div></div><div><button class='btn'>Chat</button></div>`;
          const targetUid = u.uid || u.otherUid || u.id;
          row
            .querySelector("button")
            .addEventListener("click", () => startChatWith(targetUid));
          recentList.appendChild(row);
        });
      }

      // Add contact by email via + button
      inviteBtn.addEventListener("click", async () => {
        const email = prompt("Add contact by email");
        if (!email) return;
        try {
          await addContactByEmail(email.trim().toLowerCase());
        } catch (e) {
          alert(e.message);
        }
      });

      async function addContactByEmail(email) {
        const me = auth.currentUser;
        if (!me) throw new Error("Not signed in");
        const usersRef = collection(db, "users");
        const qy = query(usersRef, where("email", "==", email));
        const qs = await getDocs(qy);
        if (qs.empty) throw new Error("No user found for that email");
        const other = qs.docs[0].data();
        if (other.uid === me.uid) throw new Error("That is you");
        const meRef = doc(db, "contacts", me.uid, "items", other.uid);
        const themRef = doc(db, "contacts", other.uid, "items", me.uid);
        await setDoc(
          meRef,
          {
            uid: other.uid,
            name: other.name || "",
            email: other.email || "",
            photoURL: other.photoURL || "",
            createdAt: serverTimestamp(),
          },
          { merge: true }
        );
        await setDoc(
          themRef,
          {
            uid: me.uid,
            name: me.displayName || "",
            email: me.email || "",
            photoURL: me.photoURL || "",
            createdAt: serverTimestamp(),
          },
          { merge: true }
        );
        alert("Contact added");
      }

      // Recent chats (userChats subcollection per user for quick listing)
      function loadRecentChats() {
        const me = auth.currentUser;
        if (!me) return;

        const qy = query(
          collection(db, "userChats", me.uid, "items"),
          orderBy("updatedAt", "desc")
        );

        onSnapshot(qy, (qs) => {
          recentList.innerHTML = ""; // ‚úÖ use recentList
          qs.forEach((docSnap) => {
            const c = docSnap.data();
            const row = document.createElement("div");
            row.className = "chat-row";
            row.innerHTML = `
        <img src="${c.otherPhoto || "default.png"}" class="avatar">
        <div class="chat-info">
          <div class="chat-name">${c.otherName}</div>
          <div class="chat-last">${c.lastMessage || ""}</div>
        </div>
      `;
            row.addEventListener("click", () =>
              openChat(c.chatId, {
                uid: c.otherUid,
                name: c.otherName,
                photo: c.otherPhoto,
                email: c.otherEmail || "", // ‚úÖ pass email
              })
            );
            recentList.appendChild(row); // ‚úÖ use recentList
          });
        });
      }

      function composeChatId(a, b) {
        return a < b ? `${a}_${b}` : `${b}_${a}`;
      }

      async function startChatWith(otherUid) {
        const me = auth.currentUser;
        if (!me) return;

        const otherDoc = await getDoc(doc(db, "users", otherUid));
        if (!otherDoc.exists()) return;
        const other = otherDoc.data();

        const chatId = [me.uid, otherUid].sort().join("_");

        // save in my userChats
        await setDoc(
          doc(db, "userChats", me.uid, "items", chatId),
          {
            chatId,
            otherUid,
            otherName: other.name || "User",
            otherPhoto: other.photoURL || "",
            otherEmail: other.email || "", // ‚úÖ added email
            lastMessage: "",
            updatedAt: serverTimestamp(),
          },
          { merge: true }
        );

        // save in other user's userChats
        await setDoc(
          doc(db, "userChats", otherUid, "items", chatId),
          {
            chatId,
            otherUid: me.uid,
            otherName: me.displayName || "Me",
            otherPhoto: me.photoURL || "",
            otherEmail: me.email || "", // ‚úÖ added email
            lastMessage: "",
            updatedAt: serverTimestamp(),
          },
          { merge: true }
        );

        // finally open chat
        openChat(chatId, {
          uid: otherUid,
          name: other.name,
          photo: other.photoURL,
          email: other.email,
        });
      }

      function openChat(chatId, other) {
        activeChatId = chatId;
        chatTitle.textContent = other?.name || "Chat";
        chatSub.textContent = other?.email || ""; // ‚úÖ will now work correctly
        emptyState.hidden = true;
        composer.hidden = false;
        messagesEl.innerHTML = "";
        sidebar.classList.remove("open");

        if (messagesUnsub) messagesUnsub();
        const msgsRef = collection(db, "chats", chatId, "messages");
        const qy = query(msgsRef, orderBy("createdAt", "asc"));
        messagesUnsub = onSnapshot(qy, (qs) => {
          messagesEl.innerHTML = "";
          qs.forEach((d) => {
            const m = d.data();
            const isMe = m.senderId === auth.currentUser?.uid;
            const div = document.createElement("div");
            div.className = `bubble ${isMe ? "me" : "you"}`;
            div.textContent = m.text;
            messagesEl.appendChild(div);
          });
          messagesEl.scrollTop = messagesEl.scrollHeight;
        });
      }

      sendBtn.addEventListener("click", sendMessage);
      messageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      async function sendMessage() {
        const text = messageInput.value.trim();
        if (!text || !activeChatId) return;
        const me = auth.currentUser;
        if (!me) return;

        messageInput.value = "";

        const msgsRef = collection(db, "chats", activeChatId, "messages");
        await addDoc(msgsRef, {
          text,
          senderId: me.uid,
          createdAt: serverTimestamp(),
        });

        // 2. Ensure parent chat doc exists and update metadata
        const chatRef = doc(db, "chats", activeChatId);
        await setDoc(
          chatRef,
          {
            lastMessage: text,
            updatedAt: serverTimestamp(),
            participants: [
              me.uid,
              activeChatId.split("_").find((id) => id !== me.uid),
            ],
          },
          { merge: true }
        );

        // 3. Mirror updates in each user's userChats
        const [a, b] = activeChatId.split("_");
        const otherUid = me.uid === a ? b : a;

        await setDoc(
          doc(db, "userChats", me.uid, "items", activeChatId),
          {
            lastMessage: text,
            updatedAt: serverTimestamp(),
          },
          { merge: true }
        );

        await setDoc(
          doc(db, "userChats", otherUid, "items", activeChatId),
          {
            lastMessage: text,
            updatedAt: serverTimestamp(),
          },
          { merge: true }
        );
      }

      // Helpers
      function debounce(fn, ms) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), ms);
        };
      }
      function escapeHtml(s) {
        return s?.replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }
      function timeAgo(date) {
        const d = typeof date === "number" ? new Date(date) : date;
        const diff = Math.floor((Date.now() - d.getTime()) / 1000);
        if (diff < 60) return diff + "s";
        if (diff < 3600) return Math.floor(diff / 60) + "m";
        if (diff < 86400) return Math.floor(diff / 3600) + "h";
        return Math.floor(diff / 86400) + "d";
      }

      // Invite button simply opens mailto with this page URL (when hosted)
      inviteBtn.addEventListener("click", () => {
        const url = location.href;
        location.href = `mailto:?subject=Join me on Chatter&body=Let‚Äôs chat here: ${url}`;
      });
    </script>
  </body>
</html>
